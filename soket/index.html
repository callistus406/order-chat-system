<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebSocket Chat App</title>
    <script src="https://cdn.jsdelivr.net/npm/socket.io-client/dist/socket.io.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        background-color: #f4f4f9;
      }
      .container {
        margin-top: 20px;
        width: 60%;
        max-width: 500px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      input,
      button {
        margin: 5px;
        padding: 8px;
        font-size: 1em;
      }
      #messages {
        border: 1px solid #ccc;
        height: 400px;
        overflow-y: auto;
        margin-top: 10px;
        padding: 10px;
        background: #fff;
        border-radius: 8px;
      }
      .message {
        margin: 5px 0;
        padding: 8px;
        border-radius: 6px;
        display: flex;
        flex-direction: column;
      }
      .message.server {
        background-color: #e3f2fd;
        align-self: flex-start;
      }
      .message.client {
        background-color: #c8e6c9;
        align-self: flex-end;
      }
      .message.error {
        background-color: #ffcccb;
        color: #d8000c;
        font-weight: bold;
        align-self: center;
        text-align: center;
      }
      .message .timestamp {
        font-size: 0.7em;
        color: #555;
        text-align: right;
      }
    </style>
  </head>
  <body>
    <h2>WebSocket Chat App</h2>
    <div class="container">
      <label>WebSocket Server URL:</label>
      <input id="serverUrl" type="text" value="http://localhost:3000" />

      <label>JWT Token:</label>
      <input id="token" type="text" placeholder="Enter your token" />

      <button onclick="connect()">Connect</button>
      <button onclick="disconnect()">Disconnect</button>

      <h3>Join a Room</h3>
      <input id="roomId" type="number" placeholder="Room ID" />
      <button onclick="joinRoom()">Join Room</button>
      <button onclick="leaveRoom()">Leave Room</button>

      <h3>Send a Message</h3>
      <input id="messageContent" type="text" placeholder="Type your message" />
      <button onclick="sendMessage()">Send</button>

      <h3>Messages</h3>
      <div id="messages"></div>

      <h3>Close Chat Room</h3>
      <input
        id="closeSummary"
        type="text"
        placeholder="Summary for closing chat"
      />
      <button onclick="closeChat()">Close Chat Room</button>
    </div>

    <script>
      let socket;

      // Utility function to log messages
      const logMessage = (content, sender, timestamp = new Date(), type = 'server') => {
        const messagesDiv = document.getElementById('messages');
        const messageElement = document.createElement('div');
        messageElement.className = `message ${type}`;
        const messageContent = typeof content === 'object' ? JSON.stringify(content) : content;
        messageElement.innerHTML = `
          <strong>${sender}:</strong> ${messageContent}
          <span class="timestamp">${new Date(timestamp).toLocaleTimeString()}</span>
        `;
        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      };

      // Display Error Message
      const logError = (error) => {
        console.error('❌ Error:', error);
        logMessage(`❌ ${error.message || error}`, 'Error', new Date(), 'error');
      };

      // Clear chat messages
      const clearMessages = () => {
        document.getElementById('messages').innerHTML = '';
      };

      // Fetch Chat History via REST API
      const fetchChatHistory = async (chatRoomId) => {
        try {
          const serverUrl = document.getElementById('serverUrl').value;
          const authToken = document.getElementById('token').value;

          const response = await fetch(`${serverUrl}/api/v1/chat/${chatRoomId}/history`, {
            method: 'GET',
            headers: {
              Authorization: `Bearer ${authToken}`,
            },
          });

          if (!response.ok) {
            throw new Error(`Failed to fetch chat history: ${response.statusText}`);
          }

          const data = await response.json();
          clearMessages();

          data.data.messages.forEach((msg) => {
            logMessage(
              msg.content,
              msg.senderUsername || 'Unknown',
              msg.createdAt,
              msg.senderId === socket.auth?.userId ? 'client' : 'server'
            );
          });
        } catch (error) {
          console.error('❌ Failed to load chat history:', error.message);
          logMessage(`❌ ${error.message}`, 'Error', new Date(), 'error');
        }
      };

      // Connect to WebSocket Server
      const connect = () => {
        const serverUrl = document.getElementById('serverUrl').value;
        const authToken = document.getElementById('token').value;

        if (socket && socket.connected) {
          socket.disconnect();
          logMessage('🔌 Previous connection closed.', 'Client', new Date(), 'client');
        }

        socket = io(serverUrl, { auth: { token: authToken } });

        socket.on('connect', () => logMessage(`✅ Connected to server`, 'Client'));
        socket.on('disconnect', () => logMessage('🔴 Disconnected from server', 'Client'));
        socket.on('error', logError);

        socket.on('receive_message', (msg) => {
          logMessage(msg.content, msg.senderUsername || 'Unknown', msg.createdAt, 'server');
        });

        socket.on('chat_closed', (msg) => {
          logMessage(`🔒 Chat Closed: ${msg.message}`, 'Server', new Date(), 'error');
          disableMessageSending();
        });
      };

      // Join Room
      const joinRoom = async () => {
        const roomId = document.getElementById('roomId').value;
        if (!roomId) return logError('⚠️ Room ID is required!');
        socket.emit('join_room', { chatRoomId: Number(roomId) });
        logMessage(`🔑 Attempting to join room ${roomId}`, 'Client');
        await fetchChatHistory(roomId);
      };

      // Leave Room
      const leaveRoom = () => {
        const roomId = document.getElementById('roomId').value;
        socket.emit('leave_room', Number(roomId));
        logMessage(`🚪 Left room ${roomId}`, 'Client');
        clearMessages();
      };

      // Send Message
      const sendMessage = () => {
        const roomId = document.getElementById('roomId').value;
        const messageContent = document.getElementById('messageContent').value;
        socket.emit('send_message', { chatRoomId: Number(roomId), content: messageContent });
      };
    </script>
  </body>
</html>
